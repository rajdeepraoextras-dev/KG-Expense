<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KhanaGo - Mobile Friendly Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            min-height: 100vh;
            padding: 10px; /* Reduced for mobile */
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px; /* Slightly smaller radius for mobile */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 { font-size: 1.8em; margin-bottom: 5px; }
        .header p { font-size: 0.9em; opacity: 0.9; }

        .content { padding: 15px; }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
        }
        .stat-card h3 { font-size: 0.75em; opacity: 0.9; margin-bottom: 5px; text-transform: uppercase; }
        .stat-card .amount { font-size: 1.3em; font-weight: bold; }
        .stat-card .detail { font-size: 0.7em; opacity: 0.8; }
        
        /* Analytics */
        .analytics-section {
            background: #fff8f3;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #ffe5d9;
        }
        .breakdown-container {
            display: grid;
            grid-template-columns: 1fr; /* Stacked by default */
            gap: 15px;
        }
        @media (min-width: 768px) {
            .breakdown-container { grid-template-columns: 1fr 1fr; }
        }

        .breakdown-section {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #ffe5d9;
        }
        .breakdown-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #fff8f3;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 0.85em;
        }
        .breakdown-label { font-weight: 600; min-width: 80px; }
        .breakdown-bar-container { flex: 1; margin: 0 10px; background: #ffe5d9; height: 8px; border-radius: 4px; }
        .breakdown-bar { height: 100%; border-radius: 4px; }

        /* Form */
        .form-section {
            background: #fff8f3;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #ffe5d9;
        }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr; /* Mobile first stack */
            gap: 10px;
        }
        @media (min-width: 600px) {
            .form-grid { grid-template-columns: 1fr 1fr; }
        }
        .form-group label { font-size: 0.85em; font-weight: 600; margin-bottom: 4px; display: block; }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ffe5d9;
            border-radius: 6px;
            font-size: 16px; /* Prevents iOS zoom on focus */
        }

        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-bottom: 10px; }
        @media (min-width: 600px) {
            .btn { width: auto; margin-bottom: 0; }
        }
        .btn-primary { background: #ff6b35; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-transfer { background: white; color: #1976d2; border: 1px solid #1976d2; }

        /* Table */
        .table-wrapper { 
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch; 
            border-radius: 8px; 
            border: 1px solid #ffe5d9; 
        }
        table { width: 100%; border-collapse: collapse; min-width: 600px; font-size: 0.85em; }
        th { background: #ff6b35; color: white; padding: 12px; text-align: left; white-space: nowrap; }
        td { padding: 12px; border-bottom: 1px solid #ffe5d9; }
        .status-badge { padding: 3px 8px; border-radius: 12px; font-size: 0.75em; font-weight: bold; white-space: nowrap; }

        .loading-overlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255,255,255,0.9); z-index: 1000; justify-content: center; align-items: center; 
        }
    </style>
</head>
<body>

    <div class="loading-overlay" id="loader">üîÑ Syncing...</div>

    <div class="container">
        <div class="header">
            <h1>üçî KhanaGo</h1>
            <p>Expense & Transfer Tracker</p>
        </div>

        <div class="content">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total</h3>
                    <div class="amount" id="totalExpenses">‚Çπ0</div>
                </div>
                <div class="stat-card">
                    <h3>Approved</h3>
                    <div class="amount" id="approvedExpenses">‚Çπ0</div>
                </div>
                <div class="stat-card">
                    <h3>Pending</h3>
                    <div class="amount" id="pendingExpenses">‚Çπ0</div>
                </div>
            </div>

            <div class="analytics-section">
                <div class="breakdown-container">
                    <div class="breakdown-section">
                        <h4>Net Member Balances</h4>
                        <div id="payerBreakdown"></div>
                    </div>
                    <div class="breakdown-section">
                        <h4>Categories</h4>
                        <div id="categoryBreakdown"></div>
                    </div>
                </div>
            </div>

            <div class="form-section" id="formSection">
                <button class="btn btn-transfer" id="toggleTransferBtn" onclick="toggleTransferMode()" style="margin-bottom: 15px;">üîÑ Switch to Transfer</button>
                <div class="form-grid">
                    <div class="form-group"><label>ID</label><input type="text" id="expenseId" readonly></div>
                    <div class="form-group"><label>Date</label><input type="date" id="date"></div>
                    <div class="form-group normal-field"><label>Category</label><select id="category"><option>Food</option><option>Software</option><option>Travel</option><option>Hardware</option></select></div>
                    <div class="form-group"><label>Amount (‚Çπ)</label><input type="number" id="amount"></div>
                    <div class="form-group"><label id="payerLabel">Who Paid</label><select id="whoPaid"><option>Rajdeep Rao</option><option>Abhishek Rao</option><option>Arvind Singh</option></select></div>
                    <div class="form-group transfer-field" style="display:none"><label>Receiver</label><select id="receiver"><option value="">Select</option><option>Rajdeep Rao</option><option>Abhishek Rao</option></select></div>
                    <div class="form-group normal-field"><label>Status</label><select id="status"><option>Pending</option><option>Approved</option></select></div>
                </div>
                <div class="form-group" style="margin-top:10px;"><label>Description</label><input type="text" id="description"></div>
                <div style="margin-top:15px;">
                    <button class="btn btn-primary" onclick="addExpense()">Save Data</button>
                    <button class="btn btn-secondary" onclick="clearForm()">Reset</button>
                </div>
            </div>

            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Who Paid</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody id="tbody"></tbody>
                </table>
            </div>
            
            <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-secondary" style="background:#555; flex:1" onclick="refreshData()">üîÑ Refresh</button>
                <button class="btn btn-secondary" style="background:#dc3545; flex:1" onclick="clearAllData()">üóëÔ∏è Clear All</button>
            </div>
        </div>
    </div>

<script>
    const SUPABASE_URL = 'https://tyhrahuionsvzyuzdtkr.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_1VBBZHGNJxdtw9fWQNI1FQ__gycCpd1';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let expenses = [];
    let isTransferMode = false;

    window.onload = () => {
        document.getElementById('date').value = new Date().toISOString().split('T')[0];
        refreshData();
    };

    function toggleTransferMode() {
        isTransferMode = !isTransferMode;
        const btn = document.getElementById('toggleTransferBtn');
        document.getElementById('payerLabel').innerText = isTransferMode ? 'Sender' : 'Who Paid';
        btn.innerText = isTransferMode ? '‚úñÔ∏è Normal Expense' : 'üîÑ Switch to Transfer';
        document.querySelectorAll('.normal-field').forEach(e => e.style.display = isTransferMode ? 'none' : 'block');
        document.querySelectorAll('.transfer-field').forEach(e => e.style.display = isTransferMode ? 'block' : 'none');
    }

    async function refreshData() {
        document.getElementById('loader').style.display = 'flex';
        const { data, error } = await _supabase.from('mainlevelexpense').select('*').order('date', { ascending: false });
        if (!error) { expenses = data; render(); generateID(); }
        document.getElementById('loader').style.display = 'none';
    }

    async function addExpense() {
        const payload = {
            expenseId: document.getElementById('expenseId').value,
            date: document.getElementById('date').value,
            amount: parseFloat(document.getElementById('amount').value),
            whoPaid: document.getElementById('whoPaid').value,
            description: document.getElementById('description').value || "No details",
            category: isTransferMode ? "Internal Transfer" : document.getElementById('category').value,
            vendor: isTransferMode ? document.getElementById('receiver').value : "N/A",
            status: isTransferMode ? "Transfer" : document.getElementById('status').value
        };

        if(!payload.amount) return alert("Enter amount");

        document.getElementById('loader').style.display = 'flex';
        const { error } = await _supabase.from('mainlevelexpense').insert([payload]);
        if(!error) { clearForm(); refreshData(); }
        document.getElementById('loader').style.display = 'none';
    }

    function render() {
        const tbody = document.getElementById('tbody');
        tbody.innerHTML = expenses.map(e => `
            <tr>
                <td>${e.date}</td>
                <td><strong>${e.category}</strong></td>
                <td>‚Çπ${parseFloat(e.amount).toLocaleString()}</td>
                <td>${e.whoPaid}</td>
                <td>${e.description}</td>
            </tr>
        `).join('');
        updateStats();
    }

    function updateStats() {
        let total = 0, approved = 0, pending = 0;
        const payers = {}, cats = {};

        expenses.forEach(e => {
            const amt = parseFloat(e.amount) || 0;
            if (e.category !== "Internal Transfer") {
                total += amt;
                if(e.status === 'Approved') approved += amt;
                if(e.status === 'Pending') pending += amt;
                cats[e.category] = (cats[e.category] || 0) + amt;
            }
            payers[e.whoPaid] = (payers[e.whoPaid] || 0) + amt;
            if (e.category === "Internal Transfer") payers[e.vendor] = (payers[e.vendor] || 0) - amt;
        });

        document.getElementById('totalExpenses').innerText = '‚Çπ' + total.toLocaleString();
        document.getElementById('approvedExpenses').innerText = '‚Çπ' + approved.toLocaleString();
        document.getElementById('pendingExpenses').innerText = '‚Çπ' + pending.toLocaleString();

        renderBars('payerBreakdown', payers);
        renderBars('categoryBreakdown', cats);
    }

    function renderBars(id, map) {
        const entries = Object.entries(map);
        document.getElementById(id).innerHTML = entries.map(([k, v]) => `
            <div class="breakdown-item">
                <div class="breakdown-label">${k}</div>
                <div class="breakdown-bar-container"><div class="breakdown-bar" style="width:70%; background:#ff6b35"></div></div>
                <div>‚Çπ${Math.abs(v).toLocaleString()}</div>
            </div>
        `).join('');
    }

    function generateID() {
        const last = expenses.length > 0 ? parseInt(expenses[0].expenseId.replace('EXP','')) : 0;
        document.getElementById('expenseId').value = "EXP" + String(last + 1).padStart(3, '0');
    }

    function clearForm() {
        document.getElementById('amount').value = '';
        document.getElementById('description').value = '';
    }

    async function clearAllData() {
        if(!confirm("Wipe all data?")) return;
        await _supabase.from('mainlevelexpense').delete().neq('id', 0);
        refreshData();
    }
</script>
</body>
</html>
